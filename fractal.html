<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <title>Fractal Explorer</title>
  <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline'; img-src 'self' data:; font-src 'self'">
  <meta name="referrer" content="strict-origin-when-cross-origin">
  <link rel="icon" href="favicon.svg" type="image/svg+xml">
  <link rel="stylesheet" href="css/theme.css">
  <style>
    body {
      margin: 0; overflow: hidden;
      background: var(--silver);
      font-family: var(--font);
      font-size: 12px;
      display: flex; flex-direction: column;
      width: 100vw; height: 100vh;
      cursor: default;
    }
    canvas {
      display: block; flex: 1;
      width: 100%; cursor: crosshair;
    }
    .controls {
      display: flex; flex-wrap: wrap; align-items: center; gap: 6px;
      padding: 4px 6px;
      background: var(--silver);
      border-top: 2px solid;
      border-color: var(--white) var(--shadow) var(--shadow) var(--white);
    }
    .controls label { white-space: nowrap; }
    .controls select, .controls input[type="number"] {
      font-family: var(--font); font-size: 12px;
      padding: 1px 2px;
    }
    .controls input[type="range"] { width: 80px; }
    .controls input[type="number"] { width: 60px; }
    .ctrl-sep {
      width: 1px; height: 18px;
      border-left: 1px solid var(--shadow);
      border-right: 1px solid var(--white);
    }
    .coord-display {
      font-family: var(--mono); font-size: 11px;
      color: var(--dk-shadow);
      margin-left: auto;
      white-space: nowrap;
    }
    .btn-sm {
      font-family: var(--font); font-size: 11px;
      padding: 1px 8px; cursor: default;
      background: var(--silver);
      border: 2px solid;
      border-color: var(--white) var(--dk-shadow) var(--dk-shadow) var(--white);
      box-shadow: 1px 1px 0 var(--shadow);
    }
    .btn-sm:active {
      border-color: var(--dk-shadow) var(--white) var(--white) var(--dk-shadow);
      box-shadow: inset 1px 1px 0 var(--shadow);
    }
    .julia-params { display: none; align-items: center; gap: 4px; }
    .julia-params.visible { display: flex; }
  </style>
</head>
<body>
  <canvas id="canvas"></canvas>
  <div class="controls">
    <label><input type="checkbox" id="juliaToggle"> Julia</label>
    <div class="julia-params" id="juliaParams">
      <label>c: <input type="number" id="juliaCr" step="0.01" value="-0.7"></label>
      <input type="number" id="juliaCi" step="0.01" value="0.27015">
    </div>
    <div class="ctrl-sep"></div>
    <label>Iter: <input type="range" id="iterSlider" min="50" max="2000" value="200"></label>
    <span id="iterLabel">200</span>
    <div class="ctrl-sep"></div>
    <label>Palette:
      <select id="paletteSelect">
        <option value="0">Classic</option>
        <option value="1">Fire</option>
        <option value="2">Ocean</option>
        <option value="3">Neon</option>
      </select>
    </label>
    <div class="ctrl-sep"></div>
    <button class="btn-sm" id="resetBtn">Reset</button>
    <span class="coord-display" id="coordDisplay"></span>
  </div>

  <script>
  (function () {
    var canvas = document.getElementById('canvas');
    var gl = canvas.getContext('webgl', { antialias: false, preserveDrawingBuffer: false });
    if (!gl) {
      document.body.innerHTML = '<div style="padding:20px;text-align:center;color:#666">WebGL is not supported in this browser.</div>';
      return;
    }

    /* --- State --- */
    var centerX = -0.5, centerY = 0.0;
    var zoom = 0.003;
    var maxIter = 200;
    var isJulia = false;
    var juliaCr = -0.7, juliaCi = 0.27015;
    var palette = 0;
    var needsRender = true;

    /* --- Shader sources --- */
    var vsSource = [
      'attribute vec2 a_pos;',
      'void main() { gl_Position = vec4(a_pos, 0.0, 1.0); }'
    ].join('\n');

    var fsSource = [
      'precision highp float;',
      'uniform vec2 u_resolution;',
      'uniform vec2 u_center;',
      'uniform float u_zoom;',
      'uniform int u_maxIter;',
      'uniform int u_julia;',
      'uniform vec2 u_juliaC;',
      'uniform int u_palette;',
      '',
      'vec3 cospal(float t, vec3 a, vec3 b, vec3 c, vec3 d) {',
      '  return a + b * cos(6.28318 * (c * t + d));',
      '}',
      '',
      'vec3 getColor(float t) {',
      '  if (u_palette == 1) return cospal(t, vec3(0.5,0.1,0.0), vec3(0.5,0.4,0.3), vec3(1.0,1.0,1.0), vec3(0.0,0.15,0.2));',
      '  if (u_palette == 2) return cospal(t, vec3(0.0,0.2,0.4), vec3(0.3,0.3,0.5), vec3(1.0,1.0,1.0), vec3(0.0,0.1,0.2));',
      '  if (u_palette == 3) return cospal(t, vec3(0.5,0.5,0.5), vec3(0.5,0.5,0.5), vec3(1.0,1.0,0.5), vec3(0.8,0.9,0.3));',
      '  return cospal(t, vec3(0.5,0.5,0.5), vec3(0.5,0.5,0.5), vec3(1.0,1.0,1.0), vec3(0.0,0.1,0.2));',
      '}',
      '',
      'void main() {',
      '  vec2 uv = (gl_FragCoord.xy - u_resolution * 0.5) * u_zoom;',
      '  vec2 c, z;',
      '  if (u_julia == 1) { z = uv + u_center; c = u_juliaC; }',
      '  else { c = uv + u_center; z = vec2(0.0); }',
      '',
      '  int iter = 0;',
      '  for (int i = 0; i < 2000; i++) {',
      '    if (i >= u_maxIter) break;',
      '    float x2 = z.x * z.x;',
      '    float y2 = z.y * z.y;',
      '    if (x2 + y2 > 4.0) break;',
      '    z = vec2(x2 - y2 + c.x, 2.0 * z.x * z.y + c.y);',
      '    iter++;',
      '  }',
      '',
      '  if (iter >= u_maxIter) { gl_FragColor = vec4(0.0, 0.0, 0.0, 1.0); return; }',
      '',
      '  float fiter = float(iter) + 1.0 - log(log(length(z))) / log(2.0);',
      '  float t = fiter / 80.0;',
      '  vec3 col = getColor(t);',
      '  gl_FragColor = vec4(col, 1.0);',
      '}'
    ].join('\n');

    /* --- Compile shaders --- */
    function compileShader(src, type) {
      var s = gl.createShader(type);
      gl.shaderSource(s, src);
      gl.compileShader(s);
      return s;
    }
    var vs = compileShader(vsSource, gl.VERTEX_SHADER);
    var fs = compileShader(fsSource, gl.FRAGMENT_SHADER);
    var prog = gl.createProgram();
    gl.attachShader(prog, vs);
    gl.attachShader(prog, fs);
    gl.linkProgram(prog);
    gl.useProgram(prog);

    /* --- Full-screen quad --- */
    var buf = gl.createBuffer();
    gl.bindBuffer(gl.ARRAY_BUFFER, buf);
    gl.bufferData(gl.ARRAY_BUFFER, new Float32Array([-1,-1, 1,-1, -1,1, 1,1]), gl.STATIC_DRAW);
    var aPos = gl.getAttribLocation(prog, 'a_pos');
    gl.enableVertexAttribArray(aPos);
    gl.vertexAttribPointer(aPos, 2, gl.FLOAT, false, 0, 0);

    /* --- Uniform locations --- */
    var uRes = gl.getUniformLocation(prog, 'u_resolution');
    var uCenter = gl.getUniformLocation(prog, 'u_center');
    var uZoom = gl.getUniformLocation(prog, 'u_zoom');
    var uMaxIter = gl.getUniformLocation(prog, 'u_maxIter');
    var uJulia = gl.getUniformLocation(prog, 'u_julia');
    var uJuliaC = gl.getUniformLocation(prog, 'u_juliaC');
    var uPalette = gl.getUniformLocation(prog, 'u_palette');

    /* --- Resize --- */
    function resize() {
      var dpr = window.devicePixelRatio || 1;
      var w = canvas.clientWidth;
      var h = canvas.clientHeight;
      canvas.width = Math.round(w * dpr);
      canvas.height = Math.round(h * dpr);
      gl.viewport(0, 0, canvas.width, canvas.height);
      needsRender = true;
    }
    window.addEventListener('resize', resize);

    /* --- Render --- */
    function render() {
      if (!needsRender) return;
      needsRender = false;
      gl.uniform2f(uRes, canvas.width, canvas.height);
      gl.uniform2f(uCenter, centerX, centerY);
      gl.uniform1f(uZoom, zoom);
      gl.uniform1i(uMaxIter, maxIter);
      gl.uniform1i(uJulia, isJulia ? 1 : 0);
      gl.uniform2f(uJuliaC, juliaCr, juliaCi);
      gl.uniform1i(uPalette, palette);
      gl.drawArrays(gl.TRIANGLE_STRIP, 0, 4);
      updateCoordDisplay();
    }

    function scheduleRender() {
      needsRender = true;
      requestAnimationFrame(render);
    }

    /* --- Coordinate display --- */
    var coordEl = document.getElementById('coordDisplay');
    function updateCoordDisplay() {
      var zoomLevel = (0.003 / zoom).toFixed(1);
      coordEl.textContent = 'x:' + centerX.toFixed(8) + ' y:' + centerY.toFixed(8) + ' z:' + zoomLevel + 'x';
    }

    /* --- Mouse interaction --- */
    var dragging = false, dragX, dragY;

    canvas.addEventListener('mousedown', function (e) {
      if (e.button !== 0) return;
      dragging = true;
      dragX = e.clientX;
      dragY = e.clientY;
    });

    window.addEventListener('mousemove', function (e) {
      if (!dragging) return;
      var dx = e.clientX - dragX;
      var dy = e.clientY - dragY;
      dragX = e.clientX;
      dragY = e.clientY;
      var dpr = window.devicePixelRatio || 1;
      centerX -= dx * dpr * zoom;
      centerY += dy * dpr * zoom;
      scheduleRender();
    });

    window.addEventListener('mouseup', function () { dragging = false; });

    canvas.addEventListener('wheel', function (e) {
      e.preventDefault();
      var rect = canvas.getBoundingClientRect();
      var dpr = window.devicePixelRatio || 1;
      var mx = (e.clientX - rect.left) * dpr;
      var my = (e.clientY - rect.top) * dpr;
      var wx = (mx - canvas.width * 0.5) * zoom + centerX;
      var wy = (canvas.height * 0.5 - my) * zoom + centerY;
      var factor = e.deltaY > 0 ? 1.15 : 1 / 1.15;
      zoom *= factor;
      centerX = wx - (mx - canvas.width * 0.5) * zoom;
      centerY = wy - (canvas.height * 0.5 - my) * zoom;
      scheduleRender();
    }, { passive: false });

    /* Click in Mandelbrot mode sets Julia c */
    canvas.addEventListener('click', function (e) {
      if (isJulia) return;
      var rect = canvas.getBoundingClientRect();
      var dpr = window.devicePixelRatio || 1;
      var mx = (e.clientX - rect.left) * dpr;
      var my = (e.clientY - rect.top) * dpr;
      juliaCr = (mx - canvas.width * 0.5) * zoom + centerX;
      juliaCi = (canvas.height * 0.5 - my) * zoom + centerY;
      document.getElementById('juliaCr').value = juliaCr.toFixed(4);
      document.getElementById('juliaCi').value = juliaCi.toFixed(4);
      isJulia = true;
      document.getElementById('juliaToggle').checked = true;
      document.getElementById('juliaParams').classList.add('visible');
      centerX = 0; centerY = 0; zoom = 0.005;
      scheduleRender();
    });

    /* --- Touch interaction --- */
    var touchIds = [];
    var lastTouchDist = 0;
    var lastTouchCX = 0, lastTouchCY = 0;

    canvas.addEventListener('touchstart', function (e) {
      e.preventDefault();
      for (var i = 0; i < e.changedTouches.length; i++) {
        touchIds.push({ id: e.changedTouches[i].identifier, x: e.changedTouches[i].clientX, y: e.changedTouches[i].clientY });
      }
      if (touchIds.length === 2) {
        var dx = touchIds[1].x - touchIds[0].x;
        var dy = touchIds[1].y - touchIds[0].y;
        lastTouchDist = Math.sqrt(dx * dx + dy * dy);
        lastTouchCX = (touchIds[0].x + touchIds[1].x) / 2;
        lastTouchCY = (touchIds[0].y + touchIds[1].y) / 2;
      }
    }, { passive: false });

    canvas.addEventListener('touchmove', function (e) {
      e.preventDefault();
      for (var i = 0; i < e.changedTouches.length; i++) {
        for (var j = 0; j < touchIds.length; j++) {
          if (touchIds[j].id === e.changedTouches[i].identifier) {
            touchIds[j].x = e.changedTouches[i].clientX;
            touchIds[j].y = e.changedTouches[i].clientY;
          }
        }
      }
      if (touchIds.length === 1) {
        var t = e.changedTouches[0];
        var found = null;
        for (var k = 0; k < touchIds.length; k++) {
          if (touchIds[k].id === t.identifier) found = touchIds[k];
        }
        if (!found) return;
        var dpr = window.devicePixelRatio || 1;
        var prevX = found.x, prevY = found.y;
        /* Use the already-updated x/y from above loop */
        /* We need prior values, so track separately */
      } else if (touchIds.length === 2) {
        var dx = touchIds[1].x - touchIds[0].x;
        var dy = touchIds[1].y - touchIds[0].y;
        var dist = Math.sqrt(dx * dx + dy * dy);
        var cx = (touchIds[0].x + touchIds[1].x) / 2;
        var cy = (touchIds[0].y + touchIds[1].y) / 2;
        if (lastTouchDist > 0) {
          var factor = lastTouchDist / dist;
          var dpr2 = window.devicePixelRatio || 1;
          var rect = canvas.getBoundingClientRect();
          var mx = (cx - rect.left) * dpr2;
          var my = (cy - rect.top) * dpr2;
          var wx = (mx - canvas.width * 0.5) * zoom + centerX;
          var wy = (canvas.height * 0.5 - my) * zoom + centerY;
          zoom *= factor;
          centerX = wx - (mx - canvas.width * 0.5) * zoom;
          centerY = wy - (canvas.height * 0.5 - my) * zoom;
          /* Pan */
          centerX -= (cx - lastTouchCX) * dpr2 * zoom;
          centerY += (cy - lastTouchCY) * dpr2 * zoom;
          scheduleRender();
        }
        lastTouchDist = dist;
        lastTouchCX = cx;
        lastTouchCY = cy;
      }
    }, { passive: false });

    function touchEnd(e) {
      for (var i = 0; i < e.changedTouches.length; i++) {
        for (var j = touchIds.length - 1; j >= 0; j--) {
          if (touchIds[j].id === e.changedTouches[i].identifier) {
            touchIds.splice(j, 1);
          }
        }
      }
      lastTouchDist = 0;
    }
    canvas.addEventListener('touchend', touchEnd);
    canvas.addEventListener('touchcancel', touchEnd);

    /* Single-finger pan via tracking previous positions */
    var prevTouchX = null, prevTouchY = null;
    canvas.addEventListener('touchstart', function (e) {
      if (e.touches.length === 1) {
        prevTouchX = e.touches[0].clientX;
        prevTouchY = e.touches[0].clientY;
      }
    });
    canvas.addEventListener('touchmove', function (e) {
      if (e.touches.length === 1 && prevTouchX !== null) {
        var dpr = window.devicePixelRatio || 1;
        var dx = e.touches[0].clientX - prevTouchX;
        var dy = e.touches[0].clientY - prevTouchY;
        prevTouchX = e.touches[0].clientX;
        prevTouchY = e.touches[0].clientY;
        centerX -= dx * dpr * zoom;
        centerY += dy * dpr * zoom;
        scheduleRender();
      }
    });
    canvas.addEventListener('touchend', function () { prevTouchX = null; prevTouchY = null; });

    /* --- Controls --- */
    var juliaToggle = document.getElementById('juliaToggle');
    var juliaParams = document.getElementById('juliaParams');
    var iterSlider = document.getElementById('iterSlider');
    var iterLabel = document.getElementById('iterLabel');
    var paletteSelect = document.getElementById('paletteSelect');
    var resetBtn = document.getElementById('resetBtn');
    var crInput = document.getElementById('juliaCr');
    var ciInput = document.getElementById('juliaCi');

    juliaToggle.addEventListener('change', function () {
      isJulia = juliaToggle.checked;
      juliaParams.classList.toggle('visible', isJulia);
      if (!isJulia) { centerX = -0.5; centerY = 0; zoom = 0.003; }
      else { centerX = 0; centerY = 0; zoom = 0.005; }
      scheduleRender();
    });

    var iterDebounce = null;
    iterSlider.addEventListener('input', function () {
      iterLabel.textContent = iterSlider.value;
      clearTimeout(iterDebounce);
      iterDebounce = setTimeout(function () {
        maxIter = parseInt(iterSlider.value, 10);
        scheduleRender();
      }, 100);
    });

    paletteSelect.addEventListener('change', function () {
      palette = parseInt(paletteSelect.value, 10);
      scheduleRender();
    });

    crInput.addEventListener('change', function () {
      juliaCr = parseFloat(crInput.value) || 0;
      scheduleRender();
    });
    ciInput.addEventListener('change', function () {
      juliaCi = parseFloat(ciInput.value) || 0;
      scheduleRender();
    });

    resetBtn.addEventListener('click', function () {
      isJulia = false;
      juliaToggle.checked = false;
      juliaParams.classList.remove('visible');
      juliaCr = -0.7; juliaCi = 0.27015;
      crInput.value = '-0.7'; ciInput.value = '0.27015';
      centerX = -0.5; centerY = 0; zoom = 0.003;
      maxIter = 200; iterSlider.value = '200'; iterLabel.textContent = '200';
      palette = 0; paletteSelect.value = '0';
      scheduleRender();
    });

    /* --- Init --- */
    resize();
    render();
  })();
  </script>
</body>
</html>
