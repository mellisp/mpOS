<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>On Target</title>
  <link rel="icon" href="favicon.svg" type="image/svg+xml">
  <link rel="stylesheet" href="css/theme.css">
  <style>
    body {
      overflow: hidden; width: 100vw; height: 100vh;
      cursor: crosshair;
      background: #1a1f2e;
    }

    canvas { display: block; }

    /* Rules dialog overlay */
    .rules-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.5);
      z-index: 20;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: default;
    }

    .rules-overlay.hidden { display: none; }

    .rules-dialog {
      background: var(--silver);
      border: 2px solid;
      border-color: var(--white) var(--dk-shadow) var(--dk-shadow) var(--white);
      box-shadow: inset 1px 1px 0 var(--silver), inset -1px -1px 0 var(--shadow);
      width: 300px;
      max-width: 90vw;
    }

    .rules-dialog .window-body { padding: 16px; line-height: 1.6; }

    /* Score display — bottom left, XP-styled */
    .score-bar {
      position: fixed;
      bottom: 8px;
      left: 8px;
      z-index: 10;
      pointer-events: none;
      user-select: none;
      background: var(--silver);
      border: 2px solid;
      border-color: var(--white) var(--dk-shadow) var(--dk-shadow) var(--white);
      box-shadow: inset 1px 1px 0 var(--silver), inset -1px -1px 0 var(--shadow);
      padding: 4px 12px;
      font-size: 13px;
      font-weight: bold;
      display: none;
    }

    .score-bar.active { display: flex; gap: 12px; }

    .score-bar .status { font-weight: normal; }
    .score-bar .status.hit { color: #2e7d32; }
    .score-bar .status.miss { color: var(--error); }

    /* Game over overlay */
    .gameover-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.6);
      z-index: 20;
      display: none;
      align-items: center;
      justify-content: center;
      cursor: default;
    }

    .gameover-overlay.active { display: flex; }

    .gameover-dialog {
      background: var(--silver);
      border: 2px solid;
      border-color: var(--white) var(--dk-shadow) var(--dk-shadow) var(--white);
      box-shadow: inset 1px 1px 0 var(--silver), inset -1px -1px 0 var(--shadow);
      width: 280px;
      max-width: 90vw;
      text-align: center;
    }

    .gameover-dialog .window-body { padding: 20px; line-height: 1.6; }
    .gameover-dialog .final-score { font-size: 28px; font-weight: bold; margin: 8px 0; }
    .gameover-dialog .final-label { font-size: 13px; color: var(--dk-shadow); }

    .device-dialog { width: 360px; }

    @media (hover: none) and (pointer: coarse) {
      .device-overlay { display: flex; }
      .rules-overlay { display: none; }
    }
  </style>
</head>
<body>
  <div class="device-overlay">
    <div class="device-dialog">
      <div class="titlebar">
        <span>On Target</span>
        <div class="titlebar-btn">X</div>
      </div>
      <div class="window-body" style="padding:16px">
        <div class="error-row">
          <span class="error-icon">&#9888;</span>
          <div class="error-text">
            <strong>Keyboard &amp; Mouse Required</strong>
            This game requires a keyboard and mouse to play. Please open this page on a desktop or laptop computer.
          </div>
        </div>
        <div class="button-row">
          <a class="btn" href="/" onclick="if(window.parent!==window){event.preventDefault();parent.closeOnTarget();}">OK</a>
        </div>
      </div>
    </div>
  </div>

  <div class="rules-overlay" id="rulesOverlay">
    <div class="rules-dialog">
      <div class="titlebar">
        <span>On Target</span>
      </div>
      <div class="window-body">
        <div><strong>Player 1:</strong> Arrow keys to dodge</div>
        <div><strong>Player 2:</strong> Use the mouse to shoot!</div>
        <div style="margin-top:4px;font-size:12px;color:var(--dk-shadow);">12 shots per round</div>
        <div class="button-row" style="margin-top:12px">
          <button class="btn" id="startBtn">OK</button>
        </div>
      </div>
    </div>
  </div>

  <canvas id="gameCanvas"></canvas>

  <div class="score-bar" id="scoreBar">
    <span>Score: <span id="score">0</span></span>
    <span>Shots: <span id="shots">12</span></span>
    <span class="status" id="scoreStatus"></span>
  </div>

  <div class="gameover-overlay" id="gameoverOverlay">
    <div class="gameover-dialog">
      <div class="titlebar">
        <span>Game Over</span>
      </div>
      <div class="window-body">
        <div class="final-label">Final Score</div>
        <div class="final-score" id="finalScore">0</div>
        <div class="button-row" style="margin-top:12px;justify-content:center;">
          <button class="btn" id="playAgainBtn">Play Again</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    /* ── Canvas setup ── */
    const canvas = document.getElementById("gameCanvas");
    const ctx = canvas.getContext("2d");

    function resize() {
      canvas.width = window.innerWidth;
      canvas.height = window.innerHeight;
    }
    window.addEventListener("resize", resize);
    resize();

    /* ── DOM refs (UI overlays only) ── */
    const scoreEl = document.getElementById("score");
    const shotsEl = document.getElementById("shots");
    const scoreBar = document.getElementById("scoreBar");
    const scoreStatus = document.getElementById("scoreStatus");
    const rulesOverlay = document.getElementById("rulesOverlay");
    const gameoverOverlay = document.getElementById("gameoverOverlay");
    const finalScoreEl = document.getElementById("finalScore");

    /* ── Constants ── */
    const R = 40;                 /* target radius */
    const SPEED = 300;            /* px/sec — frame-independent */
    const MAX_SHOTS = 12;
    const HIT_DURATION = 0.8;     /* seconds */
    const MISS_DURATION = 0.6;
    const FLASH_DECAY = 6;        /* alpha units/sec */

    /* ── Ring radii (pre-computed, outer → inner) ── */
    const RINGS = [
      [R,        "#d32f2f"],
      [R * 0.9,  "#fff"],
      [R * 0.78, "#d32f2f"],
      [R * 0.62, "#fff"],
      [R * 0.46, "#d32f2f"],
      [R * 0.28, "#fff"],
      [R * 0.14, "#d32f2f"]
    ];

    /* ── Game state ── */
    let x = 100, y = 100;
    let score = 0;
    let shotsLeft = MAX_SHOTS;
    let gameStarted = false;
    let gameOver = false;

    let hitActive = false;
    let hitTimer = 0;

    let labelText = "";
    let labelColor = "";
    let labelTimer = 0;

    let flashX = 0, flashY = 0, flashAlpha = 0;

    /* ── Input ── */
    const keys = {};
    window.addEventListener("keydown", (e) => {
      if (e.key.startsWith("Arrow")) { e.preventDefault(); keys[e.key] = true; }
    });
    window.addEventListener("keyup", (e) => { keys[e.key] = false; });

    /* ── Shooting ── */
    document.body.addEventListener("mousedown", (e) => {
      if (!gameStarted || gameOver || hitActive || shotsLeft <= 0) return;

      /* Flash */
      flashX = e.clientX;
      flashY = e.clientY;
      flashAlpha = 1;

      /* Spend a shot */
      shotsLeft--;
      shotsEl.textContent = shotsLeft;

      /* Hit test */
      const cx = x;
      const cy = y;
      const dx = e.clientX - cx;
      const dy = e.clientY - cy;
      const distSq = dx * dx + dy * dy;

      if (distSq <= R * R) {
        const ratio = Math.sqrt(distSq) / R;
        const pts = ratio <= 0.33 ? 5 : ratio <= 0.66 ? 2 : 1;
        score += pts;
        scoreEl.textContent = score;

        labelText = "HIT! +" + pts;
        labelColor = "#66bb6a";
        labelTimer = HIT_DURATION;

        hitActive = true;
        hitTimer = HIT_DURATION;

        scoreStatus.textContent = "Hit! +" + pts;
        scoreStatus.className = "status hit";
      } else {
        labelText = "MISS";
        labelColor = "#ef5350";
        labelTimer = MISS_DURATION;

        scoreStatus.textContent = "Miss";
        scoreStatus.className = "status miss";
      }

      /* Check game over */
      if (shotsLeft <= 0) {
        setTimeout(endGame, hitActive ? HIT_DURATION * 1000 + 200 : MISS_DURATION * 1000 + 200);
      }
    });

    function endGame() {
      gameOver = true;
      finalScoreEl.textContent = score;
      gameoverOverlay.classList.add("active");
      scoreStatus.textContent = "";
      scoreStatus.className = "status";
    }

    function resetGame() {
      score = 0;
      shotsLeft = MAX_SHOTS;
      hitActive = false;
      hitTimer = 0;
      labelText = "";
      labelTimer = 0;
      flashAlpha = 0;
      gameOver = false;
      x = 100;
      y = 100;
      scoreEl.textContent = "0";
      shotsEl.textContent = MAX_SHOTS;
      scoreStatus.textContent = "";
      scoreStatus.className = "status";
      gameoverOverlay.classList.remove("active");
    }

    /* ── UI buttons ── */
    document.getElementById("startBtn").addEventListener("click", () => {
      rulesOverlay.classList.add("hidden");
      scoreBar.classList.add("active");
      gameStarted = true;
    });

    document.getElementById("playAgainBtn").addEventListener("click", resetGame);

    /* ── Render helpers ── */
    function drawTarget() {
      ctx.save();
      if (hitActive) ctx.globalAlpha = 0.25;
      for (let i = 0; i < RINGS.length; i++) {
        ctx.beginPath();
        ctx.arc(x, y, RINGS[i][0], 0, 6.2832);
        ctx.fillStyle = RINGS[i][1];
        ctx.fill();
      }
      ctx.restore();
    }

    function drawFlash() {
      if (flashAlpha <= 0) return;
      const grad = ctx.createRadialGradient(flashX, flashY, 0, flashX, flashY, 200);
      grad.addColorStop(0, "rgba(255,200,60," + (flashAlpha * 0.7) + ")");
      grad.addColorStop(1, "rgba(255,200,60,0)");
      ctx.fillStyle = grad;
      ctx.fillRect(flashX - 200, flashY - 200, 400, 400);
    }

    function drawLabel() {
      if (!labelText || labelTimer <= 0) return;
      ctx.save();
      ctx.font = 'bold 14px "Trebuchet MS",Tahoma,sans-serif';
      ctx.textAlign = "center";
      ctx.fillStyle = labelColor;
      ctx.fillText(labelText, x, y + R + 24);
      ctx.restore();
    }

    /* ── Game loop — fixed timestep ── */
    let prev = 0;

    function loop(now) {
      const dt = Math.min((now - prev) / 1000, 0.05);
      prev = now;

      /* Update */
      if (gameStarted && !gameOver) {
        let mx = 0, my = 0;
        if (keys.ArrowLeft)  mx -= 1;
        if (keys.ArrowRight) mx += 1;
        if (keys.ArrowUp)    my -= 1;
        if (keys.ArrowDown)  my += 1;

        if (mx | my) {
          const len = Math.sqrt(mx * mx + my * my);
          x += (mx / len) * SPEED * dt;
          y += (my / len) * SPEED * dt;
        }

        const w = canvas.width, h = canvas.height;
        if (x < R) x = R;
        else if (x > w - R) x = w - R;
        if (y < R) y = R;
        else if (y > h - R - 24) y = h - R - 24;

        if (hitTimer > 0) {
          hitTimer -= dt;
          if (hitTimer <= 0) hitActive = false;
        }
        if (labelTimer > 0) {
          labelTimer -= dt;
          if (labelTimer <= 0) {
            labelText = "";
            scoreStatus.textContent = "";
            scoreStatus.className = "status";
          }
        }
        if (flashAlpha > 0) flashAlpha = Math.max(0, flashAlpha - FLASH_DECAY * dt);
      }

      /* Render */
      ctx.fillStyle = "#1a1f2e";
      ctx.fillRect(0, 0, canvas.width, canvas.height);

      if (gameStarted) {
        drawFlash();
        drawTarget();
        drawLabel();
      }

      requestAnimationFrame(loop);
    }

    requestAnimationFrame(loop);
  </script>
</body>
</html>
